<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acompanhar Pedido - Moto</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin:0; padding:0; font-family: Arial,sans-serif; }
  header { background:#ff2d2d; color:white; text-align:center; padding:15px; font-size:20px; }
  #map { width:100%; height:100vh; }
</style>
</head>
<body>

<header>üçî Acompanhar Pedido</header>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SHEET_URL = "https://api.sheetbest.com/sheets/3198fc28-4ca0-4fde-86b1-fbe8d3"; // Sua API

let map = L.map('map');
let marker = null;
let rota = null;
let lastPos = null;

// Tiles Carto Light (gratuito)
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

// √çcone da moto
const motoIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',
  iconSize: [50,50],
  iconAnchor: [25,25],
  popupAnchor: [0,-20]
});

// Fun√ß√£o para calcular √¢ngulo da moto
function calcularAngulo(from, to){
  const dx = to.lng - from.lng;
  const dy = to.lat - from.lat;
  return Math.atan2(dy, dx) * 180 / Math.PI;
}

// Movimento suave e rota√ß√£o
function moverMoto(marker, newLatLng){
  if(!marker) return;
  const start = marker.getLatLng();
  const steps = 20;
  const duration = 1000;
  let i=0;
  const deltaLat = (newLatLng.lat-start.lat)/steps;
  const deltaLng = (newLatLng.lng-start.lng)/steps;
  const angulo = calcularAngulo(start,newLatLng);

  const interval = duration/steps;
  const move = setInterval(()=>{
    if(i>=steps){ clearInterval(move); return; }
    const lat = start.lat+deltaLat*(i+1);
    const lng = start.lng+deltaLng*(i+1);
    marker.setLatLng([lat,lng]);
    marker.getElement()?.style.setProperty('transform', `rotate(${angulo}deg)`);
    i++;
  }, interval);
}

// Atualiza mapa
async function atualizarMapa(){
  try{
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    if(!data.length) return;

    const ultima = data[data.length-1];
    if(ultima.status!=="ativo") return;

    const lat = parseFloat(ultima.latitude);
    const lon = parseFloat(ultima.longitude);
    if(isNaN(lat)||isNaN(lon)) return;

    const pos = L.latLng(lat,lon);

    if(!marker){
      marker = L.marker(pos,{icon:motoIcon}).addTo(map).bindPopup("üöÄ Entregador aqui!");
      map.setView(pos,16);
      lastPos = pos;
    } else {
      moverMoto(marker,pos);
      map.panTo(pos,{animate:true,duration:1});
    }

    // Desenhar rota entre √∫ltimo ponto e novo
    if(rota){
      map.removeLayer(rota);
    }
    if(lastPos){
      rota = L.polyline([lastPos,pos],{color:'red',weight:4}).addTo(map);
    }
    lastPos = pos;

  } catch(e){
    console.error("Erro ao buscar dados da API:", e);
  }
}

// Primeiro fetch
atualizarMapa();
// Atualiza√ß√£o cont√≠nua
setInterval(atualizarMapa,5000);

</script>
</body>
</html>
