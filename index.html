<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acompanhar Pedido - Moto</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
  header { background: #ff2d2d; color: white; text-align: center; padding: 15px; font-size: 20px; }
  #map { width: 100%; height: 100vh; }
</style>
</head>
<body>

<header>üçî Acompanhar Pedido</header>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SHEET_URL = "https://api.sheetbest.com/sheets/3198fc28-4ca0-4fde-86b1-fbe8d3"; // Sua API
let map = L.map('map').setView([-23.55, -46.63], 16);

// Mapa estilo moderno (Carto Light)
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

// √çcone da moto
const motoIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', // PNG transparente de moto
  iconSize: [50, 50],
  iconAnchor: [25, 25],
  popupAnchor: [0, -20]
});

let marker = null;

// Fun√ß√£o para interpolar movimento suave
function moveMarkerSmooth(marker, newLatLng, steps = 10, duration = 500) {
  if (!marker) return;
  const start = marker.getLatLng();
  let i = 0;
  const deltaLat = (newLatLng.lat - start.lat) / steps;
  const deltaLng = (newLatLng.lng - start.lng) / steps;

  const interval = duration / steps;
  const move = setInterval(() => {
    if (i >= steps) { clearInterval(move); return; }
    marker.setLatLng([start.lat + deltaLat*(i+1), start.lng + deltaLng*(i+1)]);
    i++;
  }, interval);
}

// Atualiza posi√ß√£o da moto
async function atualizarMapa() {
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    if (!data.length) return;

    const ultima = data[data.length-1];
    if (ultima.status !== "ativo") return;

    const lat = parseFloat(ultima.latitude);
    const lon = parseFloat(ultima.longitude);
    if (isNaN(lat) || isNaN(lon)) return;

    const pos = L.latLng(lat, lon);

    if (!marker) {
      marker = L.marker(pos, {icon: motoIcon}).addTo(map).bindPopup("üöÄ Entregador aqui!");
      map.setView(pos, 16);
    } else {
      moveMarkerSmooth(marker, pos, 20, 1000); // anima√ß√£o suave
    }

  } catch(e) {
    console.error("Erro ao buscar dados da API:", e);
  }
}

// Atualiza a cada 5 segundos
atualizarMapa();
setInterval(atualizarMapa, 5000);

</script>
</body>
</html>
