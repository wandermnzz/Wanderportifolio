<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tech WM — Loja</title>
<style>
  :root{
    --bg:#0b0f13;
    --card:#0f1720;
    --accent:#0ea5ff;
    --muted:#94a3b8;
    --success:#10b981;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, #02040a 0%, #071226 100%);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    padding-bottom:120px;
  }

  /* Container */
  .wrap{
    max-width:980px;
    margin:16px auto;
    padding:16px;
  }

  header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:18px;
  }
  .logo{
    width:56px;
    height:56px;
    border-radius:10px;
    background:var(--glass);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .logo img{width:100%;height:100%;object-fit:contain}
  h1{font-size:20px;margin:0}
  p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

  /* Hero / main card */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:16px;
    box-shadow: 0 6px 20px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  .main-grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  .cta-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{
    background:linear-gradient(90deg,var(--accent),#0088ff);
    border:none;
    color:white;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    box-shadow: 0 6px 18px rgba(14,165,255,0.12);
  }
  .btn.secondary{
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:var(--muted);
    font-weight:600;
  }

  /* Floating revendedor button */
  .rev-btn{
    position:fixed;
    right:14px;
    bottom:22px;
    z-index:1200;
    width:64px;
    height:64px;
    border-radius:999px;
    background:linear-gradient(180deg, #06b6d4, #0ea5ff);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#022;
    font-weight:700;
    box-shadow: 0 10px 30px rgba(14,165,255,0.18);
    cursor:pointer;
    border:2px solid rgba(255,255,255,0.06);
  }
  .rev-btn small{display:block;font-size:11px; color:rgba(1,6,12,0.8)}

  /* Open/Closed badge fixed bottom-left */
  .status-badge{
    position:fixed;
    left:12px;
    bottom:18px;
    z-index:1200;
    background:rgba(0,0,0,0.5);
    backdrop-filter: blur(6px);
    padding:10px 12px;
    border-radius:12px;
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid rgba(255,255,255,0.04);
    min-width:120px;
  }
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.open{background:var(--success)}
  .dot.closed{background:var(--danger)}
  .status-text{font-weight:700;font-size:13px}
  .status-sub{font-size:12px;color:var(--muted)}

  /* Modal */
  .modal-back{
    position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:1300;
  }
  .modal{
    max-width:420px;width:94%;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);
  }
  .modal h3{margin:8px 0 12px}
  input, textarea, select{
    width:100%;
    padding:10px;
    margin-bottom:10px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.04);
    background:rgba(255,255,255,0.02);
    color:inherit;
  }

  /* Panel */
  .panel{
    margin-top:12px;
  }
  .panel .box{
    background:rgba(255,255,255,0.02);
    padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03)
  }
  .small{font-size:13px;color:var(--muted)}
  .req-item{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
  .status-pill{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .status-Aguardando{background:rgba(255,255,255,0.03)}
  .status-Em\ análise{background:rgba(255,255,255,0.03)}
  .status-Aprovado{background:rgba(16,185,129,0.12);color:var(--success)}
  .status-Negado{background:rgba(239,68,68,0.08);color:var(--danger)}

  footer{margin-top:28px;color:var(--muted);font-size:13px;text-align:center;padding:20px 0}

  @media(min-width:720px){
    .main-grid{grid-template-columns: 1fr 360px}
    .logo{width:64px;height:64px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" id="logoPlace">
        <!-- Substitua por sua imagem local "logo.png" na mesma pasta para aparecer aqui -->
        <img src="logo.png" alt="Tech WM" onerror="this.style.display='none'">
        <svg id="logoSVG" viewBox="0 0 24 24" width="34" height="34" style="display:block">
          <rect x="1" y="1" width="22" height="22" rx="6" fill="#08232d"></rect>
          <path d="M6 16 L10 8 L14 16" stroke="#0ea5ff" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>
      <div>
        <h1>Tech WM</h1>
        <p class="lead">Peças, acessórios e atendimento para revenda técnica</p>
      </div>
    </header>

    <div class="card main-grid">
      <div>
        <h2 style="margin-top:0">Bem-vindo à Tech WM</h2>
        <p class="small">Compre acessórios ou acesse a área do revendedor para preços especiais e solicitações de garantia.</p>

        <div style="margin-top:12px" class="cta-row">
          <button class="btn" onclick="openProducts()">Ver produtos</button>
          <button class="btn secondary" onclick="openInfo()">Como funciona a garantia</button>
        </div>

        <div style="margin-top:14px" class="box" id="quickInfo">
          <p class="small"><strong>Dica:</strong> Para revendedores técnicos, crie sua conta na planilha (coluna <em>tipo</em> = <code>revendedor</code>) e entre pelo botão flutuante à direita.</p>
        </div>

        <div id="panelArea" style="display:none" class="panel">
          <div class="box">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small" id="welcomeUser">Olá, —</div>
                <div style="font-weight:700" id="userEmail">—</div>
              </div>
              <div>
                <button class="btn secondary" onclick="logout()">Sair</button>
              </div>
            </div>
            <hr style="opacity:0.04;margin:12px 0">
            <h4 style="margin:6px 0">Solicitar garantia</h4>
            <form id="garForm">
              <input type="text" id="gar_prod" placeholder="Produto (ex: Tela Redmi Note 8)" required>
              <input type="text" id="gar_order" placeholder="Código do pedido / nota (opcional)">
              <textarea id="gar_desc" placeholder="Descreva o defeito (fotos são recomendadas)"></textarea>
              <select id="gar_tipo">
                <option value="revendedor">Revendedor Técnico</option>
                <option value="cliente">Cliente Comum</option>
              </select>
              <button class="btn" type="submit">Enviar solicitação</button>
            </form>
          </div>

          <div class="box">
            <h4 style="margin:6px 0">Histórico de solicitações</h4>
            <div id="requestsList">
              <div class="small">Carregando...</div>
            </div>
          </div>
        </div>

      </div>

      <aside>
        <div class="card" style="padding:12px">
          <h3 style="margin-top:0">Atendimento</h3>
          <p class="small">Horário: <strong>08:00 — 18:00</strong> (Domingo fechado)</p>
          <p class="small" style="margin-top:8px">Suporte rápido via WhatsApp</p>
          <a class="btn" href="https://wa.me/559999999999" target="_blank" rel="noopener">Abrir WhatsApp</a>
        </div>

        <div class="card" style="margin-top:12px;padding:12px">
          <h4 style="margin:0 0 8px 0">Painel rápido</h4>
          <div class="small" style="margin-bottom:8px">Acesso ao painel do revendedor pelo botão flutuante.</div>
          <button class="btn secondary" onclick="openLoginModal()">Entrar como revendedor</button>
        </div>
      </aside>
    </div>

    <footer>
      Tech WM — Loja de peças e acessórios • Desenvolvido para uso móvel
    </footer>
  </div>

  <!-- Floating revendedor button -->
  <div class="rev-btn" title="Área do revendedor" onclick="openLoginModal()">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" style="transform:translateY(-1px)">
      <path d="M12 2C8.7 2 6 4.7 6 8c0 3.3 2.7 6 6 6s6-2.7 6-6c0-3.3-2.7-6-6-6zM4 20c0-2.2 3.6-4 8-4s8 1.8 8 4v1H4v-1z" fill="#022"/>
    </svg>
    <small style="line-height:10px;color:#022">Rev</small>
  </div>

  <!-- Status badge (open/closed) -->
  <div class="status-badge" id="statusBadge" aria-live="polite">
    <div class="dot closed" id="statusDot"></div>
    <div>
      <div class="status-text" id="statusMain">Fechado</div>
      <div class="status-sub" id="statusSub">Hoje: fechada</div>
    </div>
  </div>

  <!-- Modal (login) -->
  <div class="modal-back" id="modalBack" onclick="if(event.target===this)closeModal()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h3 id="loginTitle">Login - Revendedor</h3>
      <div id="loginArea">
        <input id="emailField" type="email" placeholder="E-mail" />
        <input id="senhaField" type="password" placeholder="Senha" />
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="performLogin()">Entrar</button>
          <button class="btn secondary" onclick="closeModal()">Cancelar</button>
        </div>
        <p class="small" style="margin-top:8px">Se você for um revendedor, certifique-se que sua linha <code>tipo</code> = <strong>revendedor</strong> na planilha.</p>
      </div>
      <div id="modalMsg" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
    </div>
  </div>

<script>
/* ==========================
   CONFIGURAÇÕES
   ========================== */
const API_SHEET = "https://api.sheetbest.com/sheets/72421926-ffa9-462c-9f89-59863c864884";

/* Horário de funcionamento fixo:
   Aberto a partir de 08:00 até 18:00 (não inclusivo de 18:00 -> fecha às 18:00).
   Domingo = fechado
*/
function isOpenNow() {
  try{
    const now = new Date();
    const day = now.getDay(); // 0 = domingo
    const hour = now.getHours();
    if (day === 0) return {open:false, reason:"Domingo"};
    if (hour >= 8 && hour < 18) return {open:true, reason:"Dentro do horário"};
    return {open:false, reason:"Fora do horário"};
  }catch(e){
    return {open:false, reason:"Erro horário"};
  }
}

/* Atualiza o badge de aberto/fechado */
function updateStatusBadge(){
  const s = isOpenNow();
  const dot = document.getElementById('statusDot');
  const main = document.getElementById('statusMain');
  const sub = document.getElementById('statusSub');
  if (s.open) {
    dot.classList.remove('closed'); dot.classList.add('open');
    main.textContent = "Aberto";
    sub.textContent = "Atendendo: 08:00 — 18:00";
  } else {
    dot.classList.remove('open'); dot.classList.add('closed');
    main.textContent = "Fechado";
    if (s.reason === "Domingo") sub.textContent = "Hoje: fechado (domingo)";
    else sub.textContent = "Atendimento: 08:00 — 18:00";
  }
}
/* atualizar na carga e a cada minuto (pra manter atualizado) */
updateStatusBadge();
setInterval(updateStatusBadge, 60_000);

/* ==========================
   Modais e navegação simples
   ========================== */
function openLoginModal(){ document.getElementById('modalBack').style.display='flex'; document.getElementById('emailField').focus(); }
function closeModal(){ document.getElementById('modalBack').style.display='none'; document.getElementById('modalMsg').textContent=''; }

/* Simula navegação: mostra o painel se o usuário já estiver logado */
function showPanelIfLogged(){
  const raw = localStorage.getItem('usuario');
  if (!raw) return;
  try{
    const user = JSON.parse(raw);
    document.getElementById('panelArea').style.display = 'block';
    document.getElementById('welcomeUser').textContent = `Bem-vindo, ${user.nome || 'Revendedor'}`;
    document.getElementById('userEmail').textContent = user.email || '';
    // pre-seleciona tipo no formulário com base no user.tipo
    document.getElementById('gar_tipo').value = user.tipo || 'revendedor';
    // carregar histórico
    loadMyRequests(user.email);
  }catch(e){
    console.error(e);
  }
}

/* Logout */
function logout(){
  localStorage.removeItem('usuario');
  document.getElementById('panelArea').style.display = 'none';
  alert('Você saiu da sessão.');
}

/* ==========================
   LOGIN (via SheetBest GET)
   ========================== */
async function performLogin(){
  const email = (document.getElementById('emailField').value || '').trim();
  const senha = (document.getElementById('senhaField').value || '').trim();
  const modalMsg = document.getElementById('modalMsg');
  if (!email || !senha) { modalMsg.textContent = 'Preencha e-mail e senha.'; return; }
  modalMsg.textContent = 'Conectando...';
  try{
    const res = await fetch(API_SHEET);
    if (!res.ok) throw new Error('Erro ao acessar a planilha');
    const data = await res.json();
    // procurar usuário com e-mail+senha
    const user = data.find(u => (u.email||'').toString().trim().toLowerCase() === email.toLowerCase() && (u.senha||'').toString().trim() === senha);
    if (!user) {
      modalMsg.textContent = 'Usuário ou senha inválidos.';
      return;
    }
    // sucesso: gravar no localStorage
    localStorage.setItem('usuario', JSON.stringify(user));
    modalMsg.textContent = '';
    closeModal();
    showPanelIfLogged();
    alert('Login realizado com sucesso. Bem-vindo, ' + (user.nome||user.email));
  }catch(err){
    console.error(err);
    modalMsg.textContent = 'Erro ao conectar. Verifique a internet.';
  }
}

/* ==========================
   GARANTIA: enviar e listar
   ========================== */

document.getElementById('garForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const userRaw = localStorage.getItem('usuario');
  if (!userRaw) { alert('Faça login como revendedor antes de enviar.'); return; }
  const user = JSON.parse(userRaw);
  const prod = (document.getElementById('gar_prod').value||'').trim();
  const order = (document.getElementById('gar_order').value||'').trim();
  const desc = (document.getElementById('gar_desc').value||'').trim();
  const tipo = (document.getElementById('gar_tipo').value||'revendedor').trim();

  if (!prod) { alert('Descreva o produto.'); return; }

  const payload = {
    tipo_registro: 'garantia',
    pedido: order || '',
    produto: prod,
    descricao: desc || '',
    solicitante_email: user.email || '',
    solicitante_nome: user.nome || '',
    tipo_cliente: tipo,
    status: 'Aguardando',
    data_solicitacao: new Date().toISOString()
  };

  try{
    // POST para a planilha (SheetBest aceita POST no endpoint)
    const res = await fetch(API_SHEET, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Erro ao enviar solicitação');
    // limpa form
    document.getElementById('gar_prod').value='';
    document.getElementById('gar_order').value='';
    document.getElementById('gar_desc').value='';
    alert('Solicitação enviada com sucesso! Aguarde análise.');
    // recarregar historico
    loadMyRequests(user.email);
  }catch(err){
    console.error(err);
    alert('Erro ao enviar. Verifique a conexão.');
  }
});

/* Carrega todas as solicitações e mostra apenas as do usuário */
async function loadMyRequests(email){
  const list = document.getElementById('requestsList');
  list.innerHTML = '<div class="small">Carregando solicitações…</div>';
  try{
    const res = await fetch(API_SHEET);
    if (!res.ok) throw new Error('Erro ao buscar dados');
    const rows = await res.json();
    // filtrar só registros de garantia e do solicitante
    const my = rows.filter(r => (r.tipo_registro || '').toString().toLowerCase() === 'garantia' && (r.solicitante_email||'').toString().toLowerCase() === (email||'').toLowerCase());
    if (my.length === 0) {
      list.innerHTML = '<div class="small">Nenhuma solicitação encontrada.</div>';
      return;
    }
    // ordenar por data (mais recente primeiro) se tiver campo data_solicitacao
    my.sort((a,b)=>( (b.data_solicitacao||'') > (a.data_solicitacao||'') ? 1 : -1 ));
    list.innerHTML = '';
    my.forEach(r=>{
      const item = document.createElement('div');
      item.className = 'req-item';
      const left = document.createElement('div');
      left.style.flex='1';
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(r.produto || r.produto || '—')}</div><div class="small">${escapeHtml(r.pedido || '')}</div><div class="small">${formatShortDate(r.data_solicitacao)}</div>`;
      const right = document.createElement('div');
      const status = (r.status || 'Aguardando').replace(/\s/g,' ');
      right.innerHTML = `<div class="status-pill status-${status}">${escapeHtml(r.status || 'Aguardando')}</div>`;
      item.appendChild(left);
      item.appendChild(right);
      list.appendChild(item);
    });
  }catch(err){
    console.error(err);
    list.innerHTML = '<div class="small">Erro ao carregar solicitações.</div>';
  }
}

/* ==========================
   Helpers & utilitários
   ========================== */
function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; }); }
function formatShortDate(d){
  if (!d) return '';
  try{
    const dt = new Date(d);
    if (isNaN(dt)) return d;
    return dt.toLocaleString();
  }catch(e){return d;}
}

/* ==========================
   Funções demo (não feitas)
   ========================== */
function openProducts(){
  alert('Área de produtos — em breve aqui você verá a lista de acessórios e peças.');
}
function openInfo(){
  alert('A política de garantia: revendedores técnicos e clientes comuns têm prazos diferentes. Você pode abrir solicitações pelo painel.');
}

/* on load */
document.addEventListener('DOMContentLoaded', ()=>{
  showPanelIfLogged();
});
</script>
</body>
</html>
